#!/bin/sh
#
# This script will be executed *after* all the other init scripts.
# You can put your own initialization stuff in here if you don't
# want to do the full Sys V style init stuff.

touch /var/lock/subsys/local

PRIMARY_INTERFACE=$(ip route show default scope global | awk 'NR==1 {print $5}')
IP_ADDRESS=$(ip -o -4 a show $PRIMARY_INTERFACE | awk 'BEGIN {FS = "[ /]+"} ; {print $4}')

if [ ! -f /var/local/password ]
then
<% if @operatingsystemmajrelease == "7" %>
  GPL_PATH=/usr/share/doc/centos-release/
<% else %>
  GPL_PATH=/usr/share/doc/centos-release-6/
<% end %>

  # Generate wordlist from GPL, if word list doesn't already exist
  if [ ! -e /tmp/wordlist ]; then
    for word in $(cat $GPL_PATH/GPL)
    do
      echo $word | egrep '^[[:alpha:]]{,6}$' | tr '[A-Z]' '[a-z]' > /tmp/wordlist
    done
  fi

  # Generate password in format WORD.Number.WORD
  echo $(shuf -n 1 /tmp/wordlist).$(echo $RANDOM | cut -c-2).$(shuf -n 1 /tmp/wordlist) > /var/local/password
  echo "root:$(cat /var/local/password)" | chpasswd
fi

PASSWORD=$(cat /var/local/password)


echo \
"                --- Welcome to the PuppetLabs <%= @hostname.capitalize -%> VM ---

<%= @login_message %>




For the best experience please log in via SSH

    IP: $IP_ADDRESS
    username: root
    password: $PASSWORD

Your password was randomly generated from the text of the GNU public license
It is stored in /var/local/password and will continue to appear on this screen
" > /etc/issue

# Disable the floppy driver
rmmod floppy

/root/.ssh_keygen.sh &
